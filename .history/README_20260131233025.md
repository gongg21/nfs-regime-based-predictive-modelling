# Regime-Based Factor Timing

## Overview

This project implements a **regime-based factor timing strategy** that uses macroeconomic similarity to predict equity factor returns. By identifying the current macroeconomic regime and comparing it to similar historical periods, we generate timing signals for the Fama-French 5 factors plus Momentum (FF5+Mom).

**Key Results:**
| Portfolio | Sharpe Ratio | Total Return (1978–2025) |
|-----------|-------------|--------------------------|
| Q1 Timed (Most Similar) | 0.93 | 1003.6% |
| Untimed Long-Only | 0.97 | 1187.1% |
| Q5 Timed (Least Similar) | 0.57 | 370.3% |
| Q1-Q5 Spread | 0.31 | 114.8% |

---

## Methodology

### 1. Macroeconomic Feature Construction

For each selected macro variable (inflation, interest rates, spreads, GDP growth, etc.), construct three features:

- **Level**: Expanding-window z-score of the current value
  $$\text{Level}_t = \frac{x_t - \mu_{1:t-1}}{\sigma_{1:t-1}}$$
- **Trend**: Rolling 12-month OLS slope or momentum
- **Volatility**: Rolling 12-month standard deviation

All transformations use expanding windows to avoid look-ahead bias.

### 2. Regime Identification

- Construct a feature vector $F_t$ for each month from Level/Trend/Volatility features
- Compute similarity to all historical periods $F_s$ for $s < t$ using **Mahalanobis distance**
- Partition historical dates into **quintiles** by similarity (Q1 = most similar)

### 3. Factor Return Prediction

For each factor $i$ and target month $t$:
1. Select the K most similar historical periods (Q1 dates)
2. Compute average realized return $r_i(s+1)$ from similar periods
3. Generate signal: **LONG** if forecast > 0, **SHORT** if forecast < 0

### 4. Portfolio Construction

- Equal-weight timing signals across 6 factors: **Mkt-RF, SMB, HML, RMW, CMA, Mom**
- Optional: Optimize factor weights via Sharpe ratio maximization (train/test split)

---

## Data

### Factor Returns
- **Source**: Kenneth French Data Library
- **Factors**: Fama-French 5 Factors + Momentum (monthly, 1963–2025)
- **File**: `data/raw/F-F_Research_Data_5_Factors_2x3_with_mom.csv`

### Macroeconomic Variables
- **Source**: FRED, various
- **Variables**: Inflation, interest rates, term spread, credit spread, unemployment, etc.
- **File**: `data/raw/macro_data_1962on.csv`

### Processed Data
- `feature_matrix_clean.csv` — Level/Trend/Volatility features
- `portfolio_returns_by_quintile.csv` — Backtest returns by similarity quintile
- `factor_signals_q1.csv` — Trading signals for Q1 strategy

---

## Project Structure

```
├── data/
│   ├── raw/                          # Original data files
│   │   ├── F-F_Research_Data_5_Factors_2x3_with_mom.csv
│   │   ├── macro_data_1962on.csv
│   │   └── factor_data_description.md
│   └── processed/                    # Model-ready features & results
│       ├── feature_matrix_clean.csv
│       ├── portfolio_returns_by_quintile.csv
│       └── factor_signals_q1.csv
├── notebooks/
│   ├── exploratory_analysis.ipynb    # Initial data exploration
│   ├── feature_engineering.ipynb     # Level/Trend/Vol feature construction
│   ├── regime_identification.ipynb   # Similarity & HMM regime analysis
│   ├── portfolio_construction.ipynb  # Factor timing backtest & optimization
│   ├── feature_validation.ipynb      # Feature quality checks
│   └── performance_eval.ipynb        # Strategy evaluation
├── src/
│   ├── data_loader.py                # Data loading utilities
│   ├── feature_engineering.py        # Level/Trend/Vol computations
│   ├── regime_model.py               # KNN, Mahalanobis, HMM regime models
│   ├── factor_prediction.py          # Signal generation
│   └── evaluation.py                 # Performance metrics
├── output/                           # Charts & summary tables
│   ├── performance_q1_q5_untimed.html
│   ├── performance_q1_q5_spread.html
│   └── portfolio_comparison_summary.csv
├── docs/
│   ├── literature_review.md
│   ├── methodology_draft.md
│   └── feature_design.md
├── requirements.txt
└── makefile
```

---

## Installation

```bash
# Clone repository
git clone https://github.com/gongg21/nfs-regime-based-predictive-modelling.git
cd nfs-regime-based-predictive-modelling

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

---

## Usage

1. **Feature Engineering**: Run `notebooks/feature_engineering.ipynb` to construct Level/Trend/Volatility features
2. **Regime Identification**: Run `notebooks/regime_identification.ipynb` to compute similarity quintiles
3. **Portfolio Construction**: Run `notebooks/portfolio_construction.ipynb` to backtest factor timing strategy

---

## Key Findings

- **Q1 (most similar regimes) outperforms Q5 (least similar)** — Sharpe 0.93 vs 0.57
- **Low correlation with untimed baseline** — Q1 correlation of 0.06 suggests timing adds diversification
- **Q1-Q5 spread is weak** — Sharpe 0.31, better suited as overlay than standalone strategy
- **Optimized weights improve out-of-sample** — Test Sharpe 0.70 (optimized) vs 0.58 (equal-weight)

---

## Development

### Branch Naming
`[type]/[name]` — e.g., `feat/similarity-weights`, `fix/data-alignment`

### Commit Messages
- `feat(model): add volatility feature`
- `fix(eval): correct Sharpe calculation`

---

## References

- Fama, E. F., & French, K. R. (2015). A five-factor asset pricing model. *Journal of Financial Economics*.
- Carhart, M. M. (1997). On persistence in mutual fund performance. *Journal of Finance*.
